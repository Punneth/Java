package backend.service;

import backend.entity.ItemEntity;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.sample.crud.api.model.Item;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import org.openapitools.jackson.nullable.JsonNullable;

import java.time.OffsetDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

class ItemServiceTest {

    static class TestService extends BaseItemService {
        private final ObjectMapper objectMapper;
        
        public TestService(ObjectMapper objectMapper) {
            super(Mockito.mock(backend.repository.ItemRepository.class), 
                  Mockito.mock(backend.repository.ItemTagRepository.class));
            this.objectMapper = objectMapper;
        }
        
        // expose protected methods via wrapper
        public String newId() { return generateId(); }
        
        // Test-specific helper methods (not in BaseItemService)
        public String toJson(Map<String, String> m) {
            if (m == null || m.isEmpty()) return null;
            try {
                return objectMapper.writeValueAsString(m);
            } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
            }
        }
        
        public Map<String, String> toMap(String s) {
            if (s == null || s.isEmpty()) return new HashMap<>();
            try {
                return objectMapper.readValue(s, new TypeReference<Map<String, String>>() {});
            } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
            }
        }
        
        public Item map(ItemEntity e, List<String> tags) {
            Item item = new Item();
            item.setId(e.getId());
            item.setName(e.getName());
            item.setDescription(JsonNullable.of(e.getDescription()));
            item.setDetail(JsonNullable.of(e.getDetail()));
            
            if (e.getStatus() != null) {
                item.setStatus(Item.StatusEnum.fromValue(e.getStatus()));
            }
            
            item.setTags(tags);
            item.setMetadata(toMap(e.getMetadata()));
            item.setCreatedAt(e.getCreatedAt());
            item.setUpdatedAt(e.getUpdatedAt());
            
            return item;
        }
    }

    @Test
    void metadata_roundtrip() {
        TestService svc = new TestService(new ObjectMapper());
        Map<String, String> src = Map.of("k1", "v1", "k2", "v2");
        String json = svc.toJson(src);
        Map<String, String> dst = svc.toMap(json);
        assertThat(dst).isEqualTo(src);
    }

    @Test
    void generateId_is24hex() {
        TestService svc = new TestService(new ObjectMapper());
        String id = svc.newId();
        assertThat(id).hasSize(24);
        assertThat(id).matches("[0-9a-f]{24}");
    }

    @Test
    void entity_to_model_maps_fields() {
        TestService svc = new TestService(new ObjectMapper());
        OffsetDateTime now = OffsetDateTime.now();
        ItemEntity e = new ItemEntity("abc123456789012345678901", "name", "desc", "detail", "active", "{\"m\":\"x\"}", now, now);
        var item = svc.map(e, List.of("t1", "t2"));
        assertThat(item.getId()).isEqualTo(e.getId());
        assertThat(item.getName()).isEqualTo(e.getName());
        assertThat(item.getStatus().getValue()).isEqualTo("active");
        assertThat(item.getTags()).containsExactly("t1", "t2");
        assertThat(item.getMetadata()).containsEntry("m", "x");
        assertThat(item.getCreatedAt()).isEqualTo(now);
        assertThat(item.getUpdatedAt()).isEqualTo(now);
    }
}
